<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friend Circle Emergency Fund</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .main-app { display: none; }
        .auth-screen { display: flex; }
        .nav-link.active {
            background-color: #3b82f6;
            color: white;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 300px;
            margin: auto;
            height: 300px;
        }
        .gemini-output {
            white-space: pre-wrap;
            background-color: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
            line-height: 1.5;
            color: #374151;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Auth Screen -->
    <div id="auth-screen" class="auth-screen min-h-screen w-full items-center justify-center bg-gray-100 p-4">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
            <div>
                <h2 class="text-center text-3xl font-bold text-gray-900">
                    Friend Circle Emergency Fund
                </h2>
                <p class="mt-2 text-center text-sm text-gray-600">
                    Please select your profile to log in
                </p>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="user-select" class="sr-only">Select User</label>
                    <select id="user-select" class="relative block w-full appearance-none rounded-md border border-gray-300 px-3 py-3 text-gray-900 placeholder-gray-500 focus:z-10 focus:border-blue-500 focus:outline-none focus:ring-blue-500 sm:text-sm">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <button id="login-btn" class="group relative flex w-full justify-center rounded-md border border-transparent bg-blue-600 py-3 px-4 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Log In
                </button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app" class="main-app">
        <div class="relative min-h-screen md:flex">
            <!-- Mobile Menu Overlay -->
            <div id="mobile-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
            <!-- Sidebar -->
            <aside id="sidebar" class="w-64 flex-shrink-0 bg-white border-r border-gray-200 flex flex-col fixed inset-y-0 left-0 z-30 transform -translate-x-full transition-transform duration-300 ease-in-out md:relative md:translate-x-0">
                <div class="h-16 flex items-center justify-between px-4 border-b border-gray-200">
                    <h1 class="text-xl font-bold text-gray-800">Emergency Fund</h1>
                     <button id="close-menu-btn" class="md:hidden p-1 text-gray-500 hover:text-gray-800">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <nav class="flex-1 px-4 py-4 space-y-2">
                    <a href="#dashboard" class="nav-link flex items-center px-3 py-2 text-gray-600 hover:bg-blue-500 hover:text-white rounded-md">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                        Dashboard
                    </a>
                    <a href="#contribute" class="nav-link flex items-center px-3 py-2 text-gray-600 hover:bg-blue-500 hover:text-white rounded-md">
                         <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1m0-1V4m0 2.01V8m0 0h.01M12 16h.01M12 18v-2m0-1v-1m0-1V4m0 12v2m0 2v1m0 1v1M5 12H4m1 0h.01M7 12H6m11 0h-1m-1 0h.01M17 12h1m-1-5.657l.707-.707m2.122 2.122l-.707.707M6.343 7.05l.707.707m-2.122 2.122l-.707-.707m12.728 10.607l-.707.707M7.05 17.657l-.707.707m2.122-2.122l.707-.707"></path></svg>
                        Contribute
                    </a>
                    <a href="#borrow" class="nav-link flex items-center px-3 py-2 text-gray-600 hover:bg-blue-500 hover:text-white rounded-md">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path></svg>
                        Borrow
                    </a>
                    <a href="#repay" class="nav-link flex items-center px-3 py-2 text-gray-600 hover:bg-blue-500 hover:text-white rounded-md">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0V15m0-8l-8 8-4-4-6 6"></path></svg>
                        Repay
                    </a>
                    <a href="#transactions" class="nav-link flex items-center px-3 py-2 text-gray-600 hover:bg-blue-500 hover:text-white rounded-md">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        My Transactions
                    </a>
                    <a href="#group-activity" class="nav-link flex items-center px-3 py-2 text-gray-600 hover:bg-blue-500 hover:text-white rounded-md">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        Group Activity
                    </a>
                </nav>
                <div class="px-4 py-4 mt-auto">
                    <button id="logout-btn" class="w-full flex items-center justify-center px-3 py-2 text-gray-600 hover:bg-red-500 hover:text-white rounded-md">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        Logout
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1">
                 <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-4 sm:px-6">
                    <button id="menu-btn" class="md:hidden p-1 text-gray-500 hover:text-gray-800">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <div class="flex-1 text-center md:text-left">
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-900" id="welcome-header">Welcome!</h2>
                    </div>
                </header>
                
                <div class="p-4 sm:p-6 lg:p-10">
                    <p class="text-gray-500 mb-8" id="current-date"></p>
                    <div id="content-container">
                        <!-- Dashboard Section -->
                        <section id="dashboard" class="content-section">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <!-- Main Fund Balance -->
                                <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-sm border border-gray-200 text-center">
                                    <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Total Fund Balance</h3>
                                    <p class="mt-2 text-4xl sm:text-5xl font-bold text-blue-600" id="total-fund-balance">₹0.00</p>
                                </div>

                                <!-- Personal Stats -->
                                <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                        <h4 class="text-sm font-medium text-gray-500">My Contributions</h4>
                                        <p class="mt-2 text-3xl font-semibold text-gray-900" id="my-contributions">₹0.00</p>
                                    </div>
                                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                        <h4 class="text-sm font-medium text-gray-500">My Outstanding Loan</h4>
                                        <p class="mt-2 text-3xl font-semibold text-gray-900" id="my-loan">₹0.00</p>
                                    </div>
                                     <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                        <h4 class="text-sm font-medium text-gray-500">Interest Accrued on Loan</h4>
                                        <p class="mt-2 text-3xl font-semibold text-gray-900" id="my-interest">₹0.00</p>
                                    </div>
                                </div>
                                
                                <!-- Contribution Chart -->
                                 <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col justify-center items-center">
                                    <h4 class="text-sm font-medium text-gray-500 mb-4">My Share of the Fund</h4>
                                    <div class="chart-container">
                                        <canvas id="contribution-chart"></canvas>
                                    </div>
                                </div>
                                 <!-- Gemini Feature: Financial Tip -->
                                <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                    <h3 class="text-xl font-bold text-gray-900">✨ AI Financial Advisor</h3>
                                    <p class="mt-2 text-gray-600">Get a personalized tip based on your current financial status in the fund.</p>
                                    <button id="get-financial-tip-btn" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
                                        Get Financial Tip
                                    </button>
                                    <div id="financial-tip-loader" class="hidden loader"></div>
                                    <div id="financial-tip-output" class="hidden gemini-output"></div>
                                </div>
                            </div>
                        </section>
                        
                        <!-- Contribute Section -->
                        <section id="contribute" class="content-section hidden">
                            <div class="max-w-xl mx-auto">
                                <div class="bg-white p-6 sm:p-8 rounded-xl shadow-sm border border-gray-200">
                                    <h3 class="text-2xl font-bold text-gray-900">Make a Contribution</h3>
                                    <p class="mt-2 text-gray-600">Add funds to our collective emergency pool. Your contribution will be available immediately.</p>
                                    <div class="mt-6 space-y-4" id="contribute-form">
                                        <div>
                                            <label for="contribute-amount" class="block text-sm font-medium text-gray-700">Amount (₹)</label>
                                            <input type="number" id="contribute-amount" placeholder="e.g., 5000" class="mt-1 w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <button id="contribute-btn" class="w-full bg-blue-600 text-white font-semibold p-3 rounded-md hover:bg-blue-700">Contribute</button>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Borrow Section -->
                        <section id="borrow" class="content-section hidden">
                            <div class="max-w-xl mx-auto">
                                <div class="bg-white p-6 sm:p-8 rounded-xl shadow-sm border border-gray-200">
                                    <h3 class="text-2xl font-bold text-gray-900">Request to Borrow</h3>
                                    <p class="mt-2 text-gray-600">Request funds for an emergency. Interest is calculated at a simple 5% per annum.</p>
                                    <div class="mt-6 space-y-4" id="borrow-form">
                                        <div>
                                            <label for="borrow-amount" class="block text-sm font-medium text-gray-700">Amount (₹)</label>
                                            <input type="number" id="borrow-amount" placeholder="e.g., 10000" class="mt-1 w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                         <!-- Gemini Feature: Loan Purpose -->
                                        <div>
                                            <label for="loan-reason" class="block text-sm font-medium text-gray-700">Reason for Loan (Optional)</label>
                                            <textarea id="loan-reason" rows="3" class="mt-1 w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Urgent car repair"></textarea>
                                            <button id="analyze-reason-btn" class="mt-2 inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
                                                ✨ Analyze Reason
                                            </button>
                                            <div id="loan-reason-loader" class="hidden loader"></div>
                                            <div id="loan-reason-output" class="hidden gemini-output"></div>
                                        </div>
                                        <div id="interest-preview" class="hidden p-4 bg-gray-50 rounded-md border border-gray-200 space-y-2">
                                             <div class="flex justify-between items-center">
                                                <p class="text-sm text-gray-500">Interest (5% p.a.):</p>
                                                <p id="preview-interest" class="font-semibold text-gray-800">₹0.00</p>
                                            </div>
                                            <div class="flex justify-between items-center text-lg">
                                                <p class="font-medium text-gray-700">Total to Repay:</p>
                                                <p id="preview-total" class="font-bold text-blue-600">₹0.00</p>
                                            </div>
                                        </div>
                                        <button id="borrow-btn" class="w-full bg-orange-500 text-white font-semibold p-3 rounded-md hover:bg-orange-600">Request Funds</button>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Repay Section -->
                        <section id="repay" class="content-section hidden">
                             <div class="max-w-xl mx-auto">
                                <div class="bg-white p-6 sm:p-8 rounded-xl shadow-sm border border-gray-200">
                                    <h3 class="text-2xl font-bold text-gray-900">Repay Loan</h3>
                                    <div class="mt-4 p-4 bg-blue-50 text-blue-800 rounded-md border border-blue-200">
                                        <p>Your outstanding loan balance is: <strong id="repay-balance" class="text-xl">₹0.00</strong></p>
                                    </div>
                                    <div class="mt-6 space-y-4" id="repay-form">
                                        <div>
                                            <label for="repay-amount" class="block text-sm font-medium text-gray-700">Amount to Repay (₹)</label>
                                            <input type="number" id="repay-amount" placeholder="Enter amount" class="mt-1 w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <button id="repay-btn" class="w-full bg-green-600 text-white font-semibold p-3 rounded-md hover:bg-green-700">Repay</button>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Transactions Section -->
                        <section id="transactions" class="content-section hidden">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                                    <h3 class="text-2xl font-bold text-gray-900">My Transaction History</h3>
                                     <!-- Gemini Feature: Transaction Summary -->
                                    <button id="get-summary-btn" class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
                                       ✨ Generate Summary
                                    </button>
                                </div>
                                 <div id="summary-loader" class="hidden loader"></div>
                                 <div id="summary-output" class="hidden gemini-output"></div>
                                <div class="overflow-x-auto mt-4">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="transactions-table" class="bg-white divide-y divide-gray-200">
                                            <!-- Rows will be populated by JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </section>
                        
                        <!-- Group Activity Section -->
                        <section id="group-activity" class="content-section hidden">
                            <div class="space-y-8">
                                <!-- Member Contributions -->
                                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                    <h3 class="text-2xl font-bold text-gray-900 mb-4">Member Contributions</h3>
                                    <div id="member-contributions-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        <!-- Member cards will be populated by JS -->
                                    </div>
                                </div>

                                <!-- All Transactions -->
                                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                    <h3 class="text-2xl font-bold text-gray-900 mb-4">All Group Transactions</h3>
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Member</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody id="group-transactions-table" class="bg-white divide-y divide-gray-200">
                                                <!-- Rows will be populated by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-xl bg-white">
            <div class="text-center">
                <h3 id="modal-title" class="text-2xl font-bold text-gray-900"></h3>
                <div class="mt-4 px-7 py-3">
                    <p id="modal-message" class="text-gray-600"></p>
                </div>
                <div id="modal-buttons" class="mt-4 flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-4">
                    <!-- Buttons will be populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA SIMULATION ---
            let users = [
                { id: 1, name: 'Ankit Kushwaha', email: 'ankit@example.com', totalContributions: 0, amountBorrowed: 0, interestAccrued: 0 },
                { id: 2, name: 'Krishan Kant Jha', email: 'krishan@example.com', totalContributions: 0, amountBorrowed: 0, interestAccrued: 0 },
                { id: 3, name: 'Ashish Thakur', email: 'ashish@example.com', totalContributions: 0, amountBorrowed: 0, interestAccrued: 0 },
                { id: 4, name: 'Kumar Pal', email: 'kumarpal@example.com', totalContributions: 0, amountBorrowed: 0, interestAccrued: 0 },
                { id: 5, name: 'Pankaj', email: 'pankaj@example.com', totalContributions: 0, amountBorrowed: 0, interestAccrued: 0 },
                { id: 6, name: 'Surender', email: 'surender@example.com', totalContributions: 0, amountBorrowed: 0, interestAccrued: 0 },
                { id: 7, name: 'Rohit Kumar Chaudhary', email: 'amit@example.com', totalContributions: 0, amountBorrowed: 0, interestAccrued: 0 }
            ];

            let fund = {
                totalBalance: 0,
                totalInterestEarned: 0,
            };

            let transactions = [];
            
            let currentUser = null;
            let contributionChart = null;

            // --- UI SELECTORS ---
            const authScreen = document.getElementById('auth-screen');
            const mainApp = document.getElementById('main-app');
            const userSelect = document.getElementById('user-select');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const navLinks = document.querySelectorAll('.nav-link');
            const contentSections = document.querySelectorAll('.content-section');
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalButtons = document.getElementById('modal-buttons');
            const menuBtn = document.getElementById('menu-btn');
            const closeMenuBtn = document.getElementById('close-menu-btn');
            const sidebar = document.getElementById('sidebar');
            const mobileOverlay = document.getElementById('mobile-overlay');

            // --- UI RENDERING FUNCTIONS ---
            const formatCurrency = (amount) => `₹${amount.toFixed(2)}`;
            
            function updateUI() {
                if (!currentUser) return;

                // Headers
                document.getElementById('welcome-header').textContent = `Welcome, ${currentUser.name}!`;
                document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                // Dashboard
                document.getElementById('total-fund-balance').textContent = formatCurrency(fund.totalBalance);
                document.getElementById('my-contributions').textContent = formatCurrency(currentUser.totalContributions);
                document.getElementById('my-loan').textContent = formatCurrency(currentUser.amountBorrowed);
                document.getElementById('my-interest').textContent = formatCurrency(currentUser.interestAccrued);

                // Repay Form
                const totalOwed = currentUser.amountBorrowed + currentUser.interestAccrued;
                document.getElementById('repay-balance').textContent = formatCurrency(totalOwed);
                document.getElementById('repay-form').style.display = totalOwed > 0 ? 'block' : 'none';

                // Transaction History
                const transactionsTable = document.getElementById('transactions-table');
                transactionsTable.innerHTML = '';
                const userTransactions = transactions.filter(t => t.userId === currentUser.id).sort((a, b) => new Date(b.date) - new Date(a.date));
                if (userTransactions.length === 0) {
                     transactionsTable.innerHTML = `<tr><td colspan="4" class="text-center py-6 text-gray-500">No transactions yet.</td></tr>`;
                } else {
                    userTransactions.forEach(t => {
                        const typeClass = t.type === 'CONTRIBUTION' ? 'text-green-600' : t.type === 'BORROW' ? 'text-red-600' : 'text-blue-600';
                        const row = `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.date}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${typeClass}">${t.type}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 text-right">${formatCurrency(t.amount)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                        ${t.status}
                                    </span>
                                </td>
                            </tr>
                        `;
                        transactionsTable.innerHTML += row;
                    });
                }
                
                // Chart
                renderContributionChart();
            }

            function renderGroupActivity() {
                // Member Contributions
                const contributionsGrid = document.getElementById('member-contributions-grid');
                contributionsGrid.innerHTML = '';
                const sortedUsers = [...users].sort((a, b) => b.totalContributions - a.totalContributions);
                sortedUsers.forEach(user => {
                    const card = `
                        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <p class="font-semibold text-gray-800">${user.name}</p>
                            <p class="text-2xl font-bold text-blue-600">${formatCurrency(user.totalContributions)}</p>
                        </div>
                    `;
                    contributionsGrid.innerHTML += card;
                });

                // All Group Transactions
                const groupTransactionsTable = document.getElementById('group-transactions-table');
                groupTransactionsTable.innerHTML = '';
                const sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
                if (sortedTransactions.length === 0) {
                    groupTransactionsTable.innerHTML = `<tr><td colspan="4" class="text-center py-6 text-gray-500">No group transactions yet.</td></tr>`;
                } else {
                    sortedTransactions.forEach(t => {
                        const user = users.find(u => u.id === t.userId);
                        const typeClass = t.type === 'CONTRIBUTION' ? 'text-green-600' : t.type === 'BORROW' ? 'text-red-600' : 'text-blue-600';
                        const row = `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.date}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${typeClass}">${t.type}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 text-right">${formatCurrency(t.amount)}</td>
                            </tr>
                        `;
                        groupTransactionsTable.innerHTML += row;
                    });
                }
            }
            
            function renderContributionChart() {
                const ctx = document.getElementById('contribution-chart').getContext('2d');
                if (contributionChart) {
                    contributionChart.destroy();
                }
                const totalContributions = users.reduce((acc, user) => acc + user.totalContributions, 0);
                const otherContributions = totalContributions > 0 ? totalContributions - currentUser.totalContributions : 1; // Avoid division by zero if total is 0

                contributionChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['My Contributions', 'Others\' Contributions'],
                        datasets: [{
                            data: [currentUser.totalContributions, otherContributions],
                            backgroundColor: ['#3b82f6', '#e5e7eb'],
                            borderColor: ['#ffffff', '#ffffff'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${formatCurrency(context.raw)}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // --- MODAL LOGIC ---
            function showModal(title, message, buttons = [{ text: 'Close', class: 'bg-gray-200 hover:bg-gray-300 w-full sm:w-auto', action: hideModal }]) {
                modalTitle.textContent = title;
                modalMessage.innerHTML = message;
                modalButtons.innerHTML = '';
                buttons.forEach(btnInfo => {
                    const button = document.createElement('button');
                    button.textContent = btnInfo.text;
                    button.className = `px-6 py-2 rounded-md font-semibold ${btnInfo.class}`;
                    button.onclick = btnInfo.action;
                    modalButtons.appendChild(button);
                });
                modal.classList.remove('hidden');
            }

            function hideModal() {
                modal.classList.add('hidden');
            }

            // --- CORE LOGIC & EVENT HANDLERS ---
            function login(userId) {
                currentUser = users.find(u => u.id === parseInt(userId));
                if (currentUser) {
                    authScreen.style.display = 'none';
                    mainApp.style.display = 'block';
                    navigateTo('#dashboard');
                }
            }

            function logout() {
                currentUser = null;
                authScreen.style.display = 'flex';
                mainApp.style.display = 'none';
            }

            function toggleSidebar() {
                sidebar.classList.toggle('-translate-x-full');
                mobileOverlay.classList.toggle('hidden');
            }
            
            function navigateTo(hash) {
                contentSections.forEach(section => {
                    section.classList.toggle('hidden', `#${section.id}` !== hash);
                });
                navLinks.forEach(link => {
                    link.classList.toggle('active', link.getAttribute('href') === hash);
                });
                
                if (hash === '#group-activity') {
                    renderGroupActivity();
                } else if (currentUser) {
                    updateUI();
                }
                
                // Close sidebar on navigation on mobile
                if (!sidebar.classList.contains('-translate-x-full') && window.innerWidth < 768) {
                    toggleSidebar();
                }
            }
            
            // Transaction Handlers
            document.getElementById('contribute-btn').addEventListener('click', () => {
                const amount = parseFloat(document.getElementById('contribute-amount').value);
                if (isNaN(amount) || amount <= 0) {
                    showModal('Invalid Input', 'Please enter a positive amount to contribute.');
                    return;
                }
                
                currentUser.totalContributions += amount;
                fund.totalBalance += amount;
                transactions.push({ id: transactions.length + 1, userId: currentUser.id, type: 'CONTRIBUTION', amount, date: new Date().toISOString().split('T')[0], status: 'Completed' });
                
                showModal('Success!', `Your contribution of ${formatCurrency(amount)} has been successfully recorded.`);
                document.getElementById('contribute-amount').value = '';
                updateUI();
            });

            document.getElementById('borrow-amount').addEventListener('input', (e) => {
                const amount = parseFloat(e.target.value);
                const preview = document.getElementById('interest-preview');
                if (isNaN(amount) || amount <= 0) {
                    preview.classList.add('hidden');
                    return;
                }
                const interest = amount * 0.05;
                const total = amount + interest;
                document.getElementById('preview-interest').textContent = formatCurrency(interest);
                document.getElementById('preview-total').textContent = formatCurrency(total);
                preview.classList.remove('hidden');
            });
            
            document.getElementById('borrow-btn').addEventListener('click', () => {
                const amount = parseFloat(document.getElementById('borrow-amount').value);
                 if (isNaN(amount) || amount <= 0) {
                    showModal('Invalid Input', 'Please enter a positive amount to borrow.');
                    return;
                }
                if (currentUser.amountBorrowed > 0) {
                    showModal('Existing Loan', 'You must repay your existing loan before borrowing again.');
                    return;
                }
                if (amount > fund.totalBalance) {
                     showModal('Insufficient Funds', 'The requested amount exceeds the total fund balance.');
                    return;
                }
                
                const interest = amount * 0.05;
                const totalRepayable = amount + interest;

                const confirmAction = () => {
                    currentUser.amountBorrowed += amount;
                    currentUser.interestAccrued += interest;
                    fund.totalBalance -= amount;
                    transactions.push({ id: transactions.length + 1, userId: currentUser.id, type: 'BORROW', amount, date: new Date().toISOString().split('T')[0], status: 'Completed' });
                    
                    hideModal();
                    showModal('Success!', `Your loan of ${formatCurrency(amount)} has been approved. The funds have been transferred.`);
                    document.getElementById('borrow-amount').value = '';
                    document.getElementById('interest-preview').classList.add('hidden');
                    updateUI();
                };

                showModal(
                    'Confirm Loan Request',
                    `You are requesting to borrow <strong>${formatCurrency(amount)}</strong>.
                     <br>The interest will be <strong>${formatCurrency(interest)}</strong>, for a total repayment of <strong>${formatCurrency(totalRepayable)}</strong>.
                     <br><br>Do you wish to proceed?`,
                    [
                        { text: 'Cancel', class: 'bg-gray-200 hover:bg-gray-300 w-full sm:w-auto', action: hideModal },
                        { text: 'Confirm', class: 'bg-blue-600 hover:bg-blue-700 text-white w-full sm:w-auto', action: confirmAction }
                    ]
                );
            });

            document.getElementById('repay-btn').addEventListener('click', () => {
                const amount = parseFloat(document.getElementById('repay-amount').value);
                const totalOwed = currentUser.amountBorrowed + currentUser.interestAccrued;
                if (isNaN(amount) || amount <= 0) {
                    showModal('Invalid Input', 'Please enter a positive amount to repay.');
                    return;
                }
                if (amount > totalOwed) {
                    showModal('Invalid Amount', `You cannot repay more than your total outstanding balance of ${formatCurrency(totalOwed)}.`);
                    return;
                }

                // Logic to allocate repayment between interest and principal
                let interestPaid = Math.min(amount, currentUser.interestAccrued);
                let principalPaid = amount - interestPaid;
                
                currentUser.interestAccrued -= interestPaid;
                currentUser.amountBorrowed -= principalPaid;
                fund.totalBalance += amount;
                fund.totalInterestEarned += interestPaid;
                transactions.push({ id: transactions.length + 1, userId: currentUser.id, type: 'REPAYMENT', amount, date: new Date().toISOString().split('T')[0], status: 'Completed' });

                showModal('Success!', `Your repayment of ${formatCurrency(amount)} has been processed.`);
                document.getElementById('repay-amount').value = '';
                updateUI();
            });
            
             // --- GEMINI API INTEGRATION ---
            const API_KEY = ""; // Keep this empty
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
            
            async function callGeminiAPI(prompt, loaderElement, outputElement) {
                loaderElement.classList.remove('hidden');
                outputElement.classList.add('hidden');

                try {
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }]
                    };
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (text) {
                        outputElement.textContent = text;
                        outputElement.classList.remove('hidden');
                    } else {
                        throw new Error("No content received from API.");
                    }
                } catch (error) {
                    outputElement.textContent = `Error: ${error.message}`;
                    outputElement.classList.remove('hidden');
                } finally {
                    loaderElement.classList.add('hidden');
                }
            }

            document.getElementById('get-financial-tip-btn').addEventListener('click', () => {
                const hasLoan = currentUser.amountBorrowed > 0;
                const prompt = `
                    I am part of a friend group's emergency fund in India. Here is my current status in INR:
                    - My total contributions: ${formatCurrency(currentUser.totalContributions)}
                    - My current outstanding loan: ${formatCurrency(currentUser.amountBorrowed)}
                    - Interest accrued on my loan: ${formatCurrency(currentUser.interestAccrued)}
                    - Total fund balance: ${formatCurrency(fund.totalBalance)}

                    Based on this, give me one concise, actionable financial tip relevant to an Indian context. 
                    If I have a loan, focus on repayment strategies. 
                    If I don't have a loan, suggest a good practice for using an emergency fund wisely.
                    Keep the tone encouraging and friendly.
                `;
                callGeminiAPI(prompt, document.getElementById('financial-tip-loader'), document.getElementById('financial-tip-output'));
            });

            document.getElementById('analyze-reason-btn').addEventListener('click', () => {
                const reason = document.getElementById('loan-reason').value;
                if (!reason.trim()) {
                    showModal('Input Required', 'Please enter a reason for the loan to analyze.');
                    return;
                }
                const prompt = `
                    A member of a friends' emergency fund has requested a loan for the following reason: "${reason}".
                    Analyze this reason and provide a brief, helpful assessment. Structure your response with:
                    1.  **Urgency Level:** (e.g., High, Medium, Low).
                    2.  **Category:** (e.g., Medical, Housing, Vehicle, Discretionary).
                    3.  **Suggestion:** A short, constructive suggestion or alternative to consider.
                    Keep the tone neutral and helpful, not judgmental.
                `;
                callGeminiAPI(prompt, document.getElementById('loan-reason-loader'), document.getElementById('loan-reason-output'));
            });

            document.getElementById('get-summary-btn').addEventListener('click', () => {
                 const userTransactions = transactions.filter(t => t.userId === currentUser.id).sort((a, b) => new Date(a.date) - new Date(b.date));
                 if (userTransactions.length === 0) {
                     showModal('No Data', 'You have no transactions to summarize.');
                     return;
                 }
                 const transactionList = userTransactions.map(t => `- ${t.date}: ${t.type} of ${formatCurrency(t.amount)}`).join('\n');
                 const prompt = `
                    Generate a brief, narrative summary of the following financial transactions (in INR) for a user in a friendly, conversational tone.
                    Start by mentioning their first contribution if available. If not, just summarize the activity.
                    Here is the list of transactions:
                    ${transactionList}
                 `;
                 callGeminiAPI(prompt, document.getElementById('summary-loader'), document.getElementById('summary-output'));
            });

            // --- INITIALIZATION ---
            // Populate user dropdown
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                userSelect.appendChild(option);
            });
            
            // Event Listeners
            loginBtn.addEventListener('click', () => login(userSelect.value));
            logoutBtn.addEventListener('click', logout);
            menuBtn.addEventListener('click', toggleSidebar);
            closeMenuBtn.addEventListener('click', toggleSidebar);
            mobileOverlay.addEventListener('click', toggleSidebar);
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateTo(link.getAttribute('href'));
                });
            });

            // Handle initial page load with hash
            const initialHash = window.location.hash || '#dashboard';
            navigateTo(initialHash);
        });
    </script>
</body>
</html>

