<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friend Circle Emergency Fund</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .main-app { display: none; }
        .auth-screen { display: flex; }
        .nav-link.active {
            background-color: #3b82f6;
            color: white;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 300px;
            margin: auto;
            height: 300px;
        }
        .gemini-output {
            white-space: pre-wrap;
            background-color: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
            line-height: 1.5;
            color: #374151;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            text-transform: capitalize;
        }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-completed { background-color: #d1fae5; color: #065f46; }
        .status-rejected { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Auth Screen -->
    <div id="auth-screen" class="auth-screen min-h-screen w-full items-center justify-center bg-gray-100 p-4">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
            <div>
                <h2 class="text-center text-3xl font-bold text-gray-900">
                    Friend Circle Emergency Fund
                </h2>
                <p class="mt-2 text-center text-sm text-gray-600">
                    Please select your profile to log in
                </p>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="user-select" class="sr-only">Select User</label>
                    <select id="user-select" class="relative block w-full appearance-none rounded-md border border-gray-300 px-3 py-3 text-gray-900 placeholder-gray-500 focus:z-10 focus:border-blue-500 focus:outline-none focus:ring-blue-500 sm:text-sm">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <button id="login-btn" class="group relative flex w-full justify-center rounded-md border border-transparent bg-blue-600 py-3 px-4 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Log In
                </button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app" class="main-app">
        <div class="relative min-h-screen md:flex">
            <!-- Mobile Menu Overlay -->
            <div id="mobile-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
            <!-- Sidebar -->
            <aside id="sidebar" class="w-64 flex-shrink-0 bg-white border-r border-gray-200 flex flex-col fixed inset-y-0 left-0 z-30 transform -translate-x-full transition-transform duration-300 ease-in-out md:relative md:translate-x-0">
                <div class="h-16 flex items-center justify-between px-4 border-b border-gray-200">
                    <h1 class="text-xl font-bold text-gray-800">Emergency Fund</h1>
                     <button id="close-menu-btn" class="md:hidden p-1 text-gray-500 hover:text-gray-800">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <nav id="main-nav" class="flex-1 px-4 py-4 space-y-2">
                    <!-- Nav links will be populated by JS -->
                </nav>
                <div class="px-4 py-4 mt-auto">
                    <button id="logout-btn" class="w-full flex items-center justify-center px-3 py-2 text-gray-600 hover:bg-red-500 hover:text-white rounded-md">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        Logout
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1">
                 <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-4 sm:px-6">
                    <button id="menu-btn" class="md:hidden p-1 text-gray-500 hover:text-gray-800">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <div class="flex-1 text-center md:text-left">
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-900" id="welcome-header">Welcome!</h2>
                    </div>
                </header>
                
                <div class="p-4 sm:p-6 lg:p-10">
                    <p class="text-gray-500 mb-8" id="current-date"></p>
                    <div id="content-container">
                        <!-- Dynamic content will be injected here -->
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Modals (General and Payment) -->
    <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-xl bg-white">
            <div class="text-center">
                <h3 id="modal-title" class="text-2xl font-bold text-gray-900"></h3>
                <div class="mt-4 px-7 py-3">
                    <p id="modal-message" class="text-gray-600"></p>
                </div>
                <div id="modal-buttons" class="mt-4 flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-4"></div>
            </div>
        </div>
    </div>
    <div id="payment-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4">
        <div class="relative mx-auto w-full max-w-sm">
             <div id="payment-form" class="bg-white rounded-2xl shadow-2xl">
                <div class="p-6 text-center">
                    <div class="flex justify-center items-center mb-4">
                        <svg class="w-10 h-10 mr-2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12.86 15.8C12.54 16.11 12.06 16.11 11.74 15.8L9.25 13.3C9.04 13.09 8.9 12.81 8.84 12.5C8.78 12.19 8.82 11.87 8.94 11.58C9.06 11.29 9.27 11.05 9.53 10.9L13.97 8.5C14.24 8.35 14.56 8.32 14.87 8.41C15.18 8.49 15.45 8.7 15.63 8.97C15.81 9.24 15.88 9.56 15.83 9.87C15.78 10.18 15.61 10.47 15.36 10.66L12.86 15.8Z" fill="#4285F4"></path><path d="M11.74 15.8C11.42 15.49 11.42 14.99 11.74 14.68L14.23 12.19C14.44 11.98 14.72 11.84 15.03 11.78C15.34 11.72 15.66 11.76 15.95 11.88C16.24 12 16.48 12.21 16.63 12.47C16.78 12.73 16.82 13.05 16.74 13.36C16.65 13.67 16.44 13.94 16.17 14.12C15.9 14.3 15.58 14.37 15.27 14.32C14.96 14.27 14.67 14.1 14.48 13.85L12.03 11.41L11.74 15.8Z" fill="#34A853"></path><path d="M9.25 13.3L11.74 14.68C11.42 14.99 11.42 15.49 11.74 15.8L12.86 15.8L15.36 10.66C15.1 10.47 14.8 10.37 14.5 10.42C14.2 10.47 13.92 10.62 13.71 10.83L9.25 13.3Z" fill="#FBBC04"></path><path d="M15.8 9.87C15.85 9.56 15.78 9.24 15.6 8.97C15.42 8.7 15.15 8.49 14.84 8.41C14.53 8.32 14.21 8.35 13.94 8.5L9.5 10.9C9.24 11.05 9.03 11.29 8.91 11.58C8.79 11.87 8.83 12.19 8.89 12.5C8.95 12.81 9.09 13.09 9.3 13.3L11.74 14.68C11.94 14.47 12.18 14.26 12.42 14.05L15.8 9.87Z" fill="#EA4335"></path></svg>
                        <h3 class="text-2xl font-bold text-gray-800">Pay with Google Pay</h3>
                    </div>
                    <p class="text-gray-500 mt-2">Paying to Friend Circle Fund</p>
                    <p class="text-sm text-gray-400">ankit@example.com</p>

                    <div class="my-6">
                        <label class="block text-sm font-medium text-gray-500">Amount</label>
                        <p id="payment-amount" class="mt-1 text-4xl font-bold text-gray-900"></p>
                    </div>

                     <div class="mt-4 text-left p-4 bg-gray-50 rounded-lg">
                        <label for="upi-id" class="block text-xs font-medium text-gray-500">Paying with</label>
                        <p class="font-semibold text-gray-800">8700683984@jio</p>
                    </div>

                    <button id="pay-now-btn" class="w-full mt-6 bg-blue-600 text-white font-semibold p-4 rounded-full hover:bg-blue-700 transition duration-300">
                        Proceed to Pay
                    </button>
                </div>
            </div>
            <div id="payment-loader" class="hidden absolute inset-0 bg-white bg-opacity-90 rounded-2xl flex flex-col items-center justify-center">
                <div class="loader"></div>
                <p class="text-gray-600 mt-4">Processing with Google Pay...</p>
            </div>
        </div>
    </div>
    
    <script>
        // --- TEMPLATES for dynamic content ---
        const contentTemplates = {
            dashboard: `
                <section id="dashboard" class="content-section">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-sm border border-gray-200 text-center">
                        <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Total Fund Balance</h3>
                        <p class="mt-2 text-4xl sm:text-5xl font-bold text-blue-600" id="total-fund-balance">₹0.00</p>
                    </div>
                    <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200"><h4 class="text-sm font-medium text-gray-500">My Contributions</h4><p class="mt-2 text-3xl font-semibold text-gray-900" id="my-contributions">₹0.00</p></div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200"><h4 class="text-sm font-medium text-gray-500">My Outstanding Loan</h4><p class="mt-2 text-3xl font-semibold text-gray-900" id="my-loan">₹0.00</p></div>
                        <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-200"><h4 class="text-sm font-medium text-gray-500">Interest Accrued on Loan</h4><p class="mt-2 text-3xl font-semibold text-gray-900" id="my-interest">₹0.00</p></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col justify-center items-center"><h4 class="text-sm font-medium text-gray-500 mb-4">My Share of the Fund</h4><div class="chart-container"><canvas id="contribution-chart"></canvas></div></div>
                    <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-sm border border-gray-200"><h3 class="text-xl font-bold text-gray-900">✨ AI Financial Advisor</h3><p class="mt-2 text-gray-600">Get a personalized tip based on your current financial status in the fund.</p><button id="get-financial-tip-btn" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">Get Financial Tip</button><div id="financial-tip-loader" class="hidden loader"></div><div id="financial-tip-output" class="hidden gemini-output"></div></div>
                </div>
                </section>`,
            contribute: `
                <section id="contribute" class="content-section">
                <div class="max-w-xl mx-auto"><div class="bg-white p-6 sm:p-8 rounded-xl shadow-sm border border-gray-200"><h3 class="text-2xl font-bold text-gray-900">Request a Contribution</h3><p class="mt-2 text-gray-600">Submit a request to add funds. An admin will approve it after payment.</p><div class="mt-6 space-y-4"><label for="contribute-amount" class="block text-sm font-medium text-gray-700">Amount (₹)</label><input type="number" id="contribute-amount" placeholder="e.g., 5000" class="mt-1 w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"><button id="contribute-btn" class="w-full bg-blue-600 text-white font-semibold p-3 rounded-md hover:bg-blue-700">Request Contribution</button></div></div></div>
                </section>`,
            borrow: `
                <section id="borrow" class="content-section">
                <div class="max-w-xl mx-auto"><div class="bg-white p-6 sm:p-8 rounded-xl shadow-sm border border-gray-200"><h3 class="text-2xl font-bold text-gray-900">Request to Borrow</h3><p class="mt-2 text-gray-600">Request funds for an emergency. An admin will review your request.</p><div class="mt-6 space-y-4"><label for="borrow-amount" class="block text-sm font-medium text-gray-700">Amount (₹)</label><input type="number" id="borrow-amount" placeholder="e.g., 10000" class="mt-1 w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"><label for="loan-reason" class="block text-sm font-medium text-gray-700">Reason for Loan (Optional)</label><textarea id="loan-reason" rows="3" class="mt-1 w-full p-3 border border-gray-300 rounded-md" placeholder="e.g., Urgent car repair"></textarea><button id="analyze-reason-btn" class="mt-2 inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">✨ Analyze Reason</button><div id="loan-reason-loader" class="hidden loader"></div><div id="loan-reason-output" class="hidden gemini-output"></div><div id="interest-preview" class="hidden p-4 bg-gray-50 rounded-md border border-gray-200 space-y-2"><div class="flex justify-between items-center"><p class="text-sm text-gray-500">Interest (5% p.a.):</p><p id="preview-interest" class="font-semibold text-gray-800">₹0.00</p></div><div class="flex justify-between items-center text-lg"><p class="font-medium text-gray-700">Total to Repay:</p><p id="preview-total" class="font-bold text-blue-600">₹0.00</p></div></div><button id="borrow-btn" class="w-full bg-orange-500 text-white font-semibold p-3 rounded-md hover:bg-orange-600">Submit Borrow Request</button></div></div></div>
                </section>`,
            repay: `
                 <section id="repay" class="content-section">
                 <div class="max-w-xl mx-auto"><div class="bg-white p-6 sm:p-8 rounded-xl shadow-sm border border-gray-200"><h3 class="text-2xl font-bold text-gray-900">Request Loan Repayment</h3><div class="mt-4 p-4 bg-blue-50 text-blue-800 rounded-md border border-blue-200"><p>Your outstanding loan balance is: <strong id="repay-balance" class="text-xl">₹0.00</strong></p></div><div class="mt-6 space-y-4" id="repay-form"><label for="repay-amount" class="block text-sm font-medium text-gray-700">Amount to Repay (₹)</label><input type="number" id="repay-amount" placeholder="Enter amount" class="mt-1 w-full p-3 border border-gray-300 rounded-md"><button id="repay-btn" class="w-full bg-green-600 text-white font-semibold p-3 rounded-md hover:bg-green-700">Request Repayment</button></div></div></div>
                 </section>`,
            transactions: `
                <section id="transactions" class="content-section">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200"><div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4"><h3 class="text-2xl font-bold text-gray-900">My Transaction History</h3><button id="get-summary-btn" class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">✨ Generate Summary</button></div><div id="summary-loader" class="hidden loader"></div><div id="summary-output" class="hidden gemini-output"></div><div class="overflow-x-auto mt-4"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th><th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th></tr></thead><tbody id="transactions-table" class="bg-white divide-y divide-gray-200"></tbody></table></div></div>
                </section>`,
            'group-activity': `
                <section id="group-activity" class="content-section">
                <div class="space-y-8"><div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200"><h3 class="text-2xl font-bold text-gray-900 mb-4">Member Contributions</h3><div id="member-contributions-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div></div><div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200"><h3 class="text-2xl font-bold text-gray-900 mb-4">All Group Transactions</h3><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Member</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th><th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th></tr></thead><tbody id="group-transactions-table" class="bg-white divide-y divide-gray-200"></tbody></table></div></div></div>
                </section>`,
            'admin-panel': `
                <section id="admin-panel" class="content-section">
                 <div class="space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-2xl font-bold text-gray-900 mb-4">Admin Panel: Pending Requests</h3>
                        <div id="pending-requests-container" class="overflow-x-auto"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-2xl font-bold text-gray-900 mb-4">Group Members</h3>
                        <div id="group-members-container" class="overflow-x-auto"></div>
                    </div>
                </div>
                </section>`
        };
        const navTemplates = {
            user: `
                <a href="#dashboard" class="nav-link flex items-center px-3 py-2 text-gray-600 hover:bg-blue-500 hover:text-white rounded-md"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>Dashboard</a>
                <a href="#contribute" class="nav-link flex items-center px-3 py-2 text-gray-600 hover:bg-blue-500 hover:text-white rounded-md"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1m0-1V4m0 2.01V8m0 0h.01M12 16h.01M12 18v-2m0-1v-1m0-1V4m0 12v2m0 2v1m0 1v1M5 12H4m1 0h.01M7 12H6m11 0h-1m-1 0h.01M17 12h1m-1-5.657l.707-.707m2.122 2.122l-.707.707M6.343 7.05l.707.707m-2.122 2.122l-.707-.707m12.728 10.607l-.707.707M7.05 17.657l-.707.707m2.122-2.122l.707-.707"></path></svg>Contribute</a>
                <a href="#borrow" class="nav-link flex items-center px-3 py-2 text-gray-600 hover:bg-blue-500 hover:text-white rounded-md"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path></svg>Borrow</a>
                <a href="#repay" class="nav-link flex items-center px-3 py-2 text-gray-600 hover:bg-blue-500 hover:text-white rounded-md"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0V15m0-8l-8 8-4-4-6 6"></path></svg>Repay</a>
                <a href="#transactions" class="nav-link flex items-center px-3 py-2 text-gray-600 hover:bg-blue-500 hover:text-white rounded-md"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>My Transactions</a>
                <a href="#group-activity" class="nav-link flex items-center px-3 py-2 text-gray-600 hover:bg-blue-500 hover:text-white rounded-md"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>Group Activity</a>
            `,
            admin: `
                <a href="#admin-panel" class="nav-link flex items-center px-3 py-2 text-red-600 bg-red-50 hover:bg-red-500 hover:text-white rounded-md"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>Admin Panel</a>
            `
        };

        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA SIMULATION ---
            let users = [
                { id: 1, name: 'Ankit Kushwaha', email: 'ankit@example.com', totalContributions: 0, amountBorrowed: 0, interestAccrued: 0, isAdmin: true },
                { id: 2, name: 'Krishan Kant Jha', email: 'krishan@example.com', totalContributions: 0, amountBorrowed: 0, interestAccrued: 0, isAdmin: false },
                { id: 3, name: 'Ashish Thakur', email: 'ashish@example.com', totalContributions: 0, amountBorrowed: 0, interestAccrued: 0, isAdmin: false },
                { id: 4, name: 'Kumar Pal', email: 'kumarpal@example.com', totalContributions: 0, amountBorrowed: 0, interestAccrued: 0, isAdmin: false },
                { id: 5, name: 'Pankaj', email: 'pankaj@example.com', totalContributions: 0, amountBorrowed: 0, interestAccrued: 0, isAdmin: false },
                { id: 6, name: 'Surender', email: 'surender@example.com', totalContributions: 0, amountBorrowed: 0, interestAccrued: 0, isAdmin: false },
                { id: 7, name: 'Rohit Kumar Chaudhary', email: 'amit@example.com', totalContributions: 0, amountBorrowed: 0, interestAccrued: 0, isAdmin: false }
            ];

            let fund = { totalBalance: 0, totalInterestEarned: 0 };
            let transactions = [];
            let currentUser = null;
            let contributionChart = null;
            let pendingPaymentCallback = null;

            // --- UI SELECTORS ---
            const authScreen = document.getElementById('auth-screen');
            const mainApp = document.getElementById('main-app');
            const userSelect = document.getElementById('user-select');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const contentContainer = document.getElementById('content-container');
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalButtons = document.getElementById('modal-buttons');
            const paymentModal = document.getElementById('payment-modal');
            const paymentAmount = document.getElementById('payment-amount');
            const payNowBtn = document.getElementById('pay-now-btn');
            const paymentForm = document.getElementById('payment-form');
            const paymentLoader = document.getElementById('payment-loader');
            const menuBtn = document.getElementById('menu-btn');
            const closeMenuBtn = document.getElementById('close-menu-btn');
            const sidebar = document.getElementById('sidebar');
            const mobileOverlay = document.getElementById('mobile-overlay');

            // --- UI RENDERING & MANAGEMENT ---
            const formatCurrency = (amount) => `₹${amount.toFixed(2)}`;

            function setupNav() {
                const mainNav = document.getElementById('main-nav');
                mainNav.innerHTML = navTemplates.user;
                if (currentUser && currentUser.isAdmin) {
                    mainNav.insertAdjacentHTML('afterbegin', navTemplates.admin);
                }
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        navigateTo(link.getAttribute('href'));
                    });
                });
            }

            function updateUI() {
                if (!currentUser) return;
                const currentSection = contentContainer.querySelector('.content-section');
                if (!currentSection) return;
                const pageId = `#${currentSection.id}`;

                document.getElementById('welcome-header').textContent = `Welcome, ${currentUser.name}!`;
                document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                if (pageId === '#dashboard') {
                    document.getElementById('total-fund-balance').textContent = formatCurrency(fund.totalBalance);
                    document.getElementById('my-contributions').textContent = formatCurrency(currentUser.totalContributions);
                    document.getElementById('my-loan').textContent = formatCurrency(currentUser.amountBorrowed);
                    document.getElementById('my-interest').textContent = formatCurrency(currentUser.interestAccrued);
                    renderContributionChart();
                } else if (pageId === '#repay') {
                    const totalOwed = currentUser.amountBorrowed + currentUser.interestAccrued;
                    document.getElementById('repay-balance').textContent = formatCurrency(totalOwed);
                    document.getElementById('repay-form').style.display = totalOwed > 0 ? 'block' : 'none';
                } else if (pageId === '#transactions') {
                    renderUserTransactions();
                } else if (pageId === '#group-activity') {
                    renderGroupActivity();
                } else if (pageId === '#admin-panel' && currentUser.isAdmin) {
                    renderAdminPanel();
                }
            }
            
            // --- CORE LOGIC & EVENT HANDLERS ---
            function login(userId) {
                currentUser = users.find(u => u.id === parseInt(userId));
                if (currentUser) {
                    authScreen.style.display = 'none';
                    mainApp.style.display = 'block';
                    setupNav();
                    navigateTo('#dashboard');
                }
            }

            function logout() {
                currentUser = null;
                authScreen.style.display = 'flex';
                mainApp.style.display = 'none';
            }

            function toggleSidebar() {
                sidebar.classList.toggle('-translate-x-full');
                mobileOverlay.classList.toggle('hidden');
            }
            
            function navigateTo(hash) {
                contentContainer.innerHTML = contentTemplates[hash.replace('#', '')] || contentTemplates['dashboard'];
                
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.toggle('active', link.getAttribute('href') === hash);
                });
                
                bindPageEventListeners(hash);
                updateUI();
                
                if (!sidebar.classList.contains('-translate-x-full') && window.innerWidth < 768) {
                    toggleSidebar();
                }
            }

            function createTransactionRequest(type, amount) {
                 const newTransaction = { 
                    id: transactions.length + 1, 
                    userId: currentUser.id, 
                    type, 
                    amount, 
                    date: new Date().toISOString().split('T')[0], 
                    status: 'Pending' 
                };
                transactions.push(newTransaction);
                showModal('Request Submitted', `Your ${type.toLowerCase()} request for ${formatCurrency(amount)} has been sent to the admin for approval.`);
                updateUI();
            }

            function handleAdminAction(transactionId, newStatus) {
                const transaction = transactions.find(t => t.id === transactionId);
                const user = users.find(u => u.id === transaction.userId);
                if (!transaction || !user) return;

                if (newStatus === 'Completed') {
                    switch (transaction.type) {
                        case 'CONTRIBUTION':
                            user.totalContributions += transaction.amount;
                            fund.totalBalance += transaction.amount;
                            break;
                        case 'BORROW':
                            const interest = transaction.amount * 0.05;
                            user.amountBorrowed += transaction.amount;
                            user.interestAccrued += interest;
                            fund.totalBalance -= transaction.amount;
                            break;
                        case 'REPAYMENT':
                            let interestPaid = Math.min(transaction.amount, user.interestAccrued);
                            let principalPaid = transaction.amount - interestPaid;
                            user.interestAccrued -= interestPaid;
                            user.amountBorrowed -= principalPaid;
                            fund.totalBalance += transaction.amount;
                            fund.totalInterestEarned += interestPaid;
                            break;
                    }
                }
                transaction.status = newStatus;
                renderAdminPanel();
            }
            
            function bindPageEventListeners(pageId) {
                if (pageId === '#dashboard') {
                    document.getElementById('get-financial-tip-btn')?.addEventListener('click', handleGetFinancialTip);
                } else if (pageId === '#contribute') {
                    document.getElementById('contribute-btn')?.addEventListener('click', handleContributeRequest);
                } else if (pageId === '#borrow') {
                    document.getElementById('borrow-amount')?.addEventListener('input', handleBorrowAmountInput);
                    document.getElementById('borrow-btn')?.addEventListener('click', handleBorrowRequest);
                    document.getElementById('analyze-reason-btn')?.addEventListener('click', handleAnalyzeReason);
                } else if (pageId === '#repay') {
                    document.getElementById('repay-btn')?.addEventListener('click', handleRepayRequest);
                } else if (pageId === '#transactions') {
                    document.getElementById('get-summary-btn')?.addEventListener('click', handleGetSummary);
                }
            }

            // --- HANDLERS for page-specific events ---
            function handleContributeRequest() {
                const amount = parseFloat(document.getElementById('contribute-amount').value);
                if (isNaN(amount) || amount <= 0) { showModal('Invalid Input', 'Please enter a positive amount.'); return; }
                pendingPaymentCallback = () => createTransactionRequest('CONTRIBUTION', amount);
                showPaymentModal(amount);
            }
            function handleBorrowAmountInput(e) {
                 const amount = parseFloat(e.target.value);
                const preview = document.getElementById('interest-preview');
                if (isNaN(amount) || amount <= 0) {
                    preview.classList.add('hidden');
                    return;
                }
                const interest = amount * 0.05;
                const total = amount + interest;
                document.getElementById('preview-interest').textContent = formatCurrency(interest);
                document.getElementById('preview-total').textContent = formatCurrency(total);
                preview.classList.remove('hidden');
            }
            function handleBorrowRequest() {
                const amount = parseFloat(document.getElementById('borrow-amount').value);
                if (isNaN(amount) || amount <= 0) { showModal('Invalid Input', 'Please enter a positive amount to borrow.'); return; }
                if (currentUser.amountBorrowed > 0) { showModal('Existing Loan', 'You have an outstanding loan. Please repay it before requesting another.'); return; }
                if (amount > fund.totalBalance) { showModal('Insufficient Funds', 'The requested amount exceeds the total fund balance.'); return; }
                createTransactionRequest('BORROW', amount);
                document.getElementById('borrow-amount').value = '';
            }
            function handleRepayRequest() {
                const amount = parseFloat(document.getElementById('repay-amount').value);
                const totalOwed = currentUser.amountBorrowed + currentUser.interestAccrued;
                if (isNaN(amount) || amount <= 0) { showModal('Invalid Input', 'Please enter a positive amount to repay.'); return; }
                if (amount > totalOwed) { showModal('Invalid Amount', `You cannot repay more than your total outstanding balance of ${formatCurrency(totalOwed)}.`); return; }
                pendingPaymentCallback = () => createTransactionRequest('REPAYMENT', amount);
                showPaymentModal(amount);
            }
            
            function showPaymentModal(amount) {
                paymentAmount.textContent = formatCurrency(amount);
                paymentForm.style.display = 'block';
                paymentLoader.style.display = 'none';
                paymentModal.classList.remove('hidden');
            }
            payNowBtn.addEventListener('click', () => {
                paymentForm.style.display = 'none';
                paymentLoader.style.display = 'block';
                setTimeout(() => {
                    paymentModal.classList.add('hidden');
                    if (pendingPaymentCallback) {
                        pendingPaymentCallback();
                        pendingPaymentCallback = null;
                    }
                }, 2000);
            });

            // --- RENDER FUNCTIONS for dynamic tables ---
            function renderAdminPanel() {
                const requestsContainer = document.getElementById('pending-requests-container');
                const membersContainer = document.getElementById('group-members-container');
                
                const pending = transactions.filter(t => t.status === 'Pending');
                if(pending.length === 0){
                    requestsContainer.innerHTML = `<p class="text-gray-500">No pending requests.</p>`;
                } else {
                    let table = `<table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Member</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Amount</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
                    pending.forEach(t => {
                        const user = users.find(u => u.id === t.userId);
                        table += `<tr>
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.name}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${t.type}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-800 text-right">${formatCurrency(t.amount)}</td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-center space-x-2">
                                <button class="approve-btn inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700" data-id="${t.id}">Approve</button>
                                <button class="reject-btn inline-flex items-center px-2.5 py-1.5 border border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" data-id="${t.id}">Reject</button>
                            </td>
                        </tr>`;
                    });
                    table += `</tbody></table>`;
                    requestsContainer.innerHTML = table;
                    requestsContainer.querySelectorAll('.approve-btn').forEach(b => b.addEventListener('click', e => handleAdminAction(parseInt(e.target.dataset.id), 'Completed')));
                    requestsContainer.querySelectorAll('.reject-btn').forEach(b => b.addEventListener('click', e => handleAdminAction(parseInt(e.target.dataset.id), 'Rejected')));
                }
                
                let membersTable = `<table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50"><tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Contributions</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Loan</th>
                        </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
                users.forEach(u => {
                    membersTable += `<tr>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${u.name} ${u.isAdmin ? '(Admin)' : ''}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-800 text-right">${formatCurrency(u.totalContributions)}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-800 text-right">${formatCurrency(u.amountBorrowed)}</td>
                    </tr>`;
                });
                membersTable += `</tbody></table>`;
                membersContainer.innerHTML = membersTable;
            }

            function renderUserTransactions() {
                const tableBody = document.getElementById('transactions-table');
                tableBody.innerHTML = '';
                const userTransactions = transactions.filter(t => t.userId === currentUser.id).sort((a, b) => new Date(b.date) - new Date(a.date));
                if(userTransactions.length === 0){
                    tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-6 text-gray-500">No transactions yet.</td></tr>`;
                    return;
                }
                userTransactions.forEach(t => {
                    const typeClass = t.type === 'CONTRIBUTION' ? 'text-green-600' : t.type === 'BORROW' ? 'text-red-600' : 'text-blue-600';
                    const statusClass = `status-${t.status.toLowerCase()}`;
                    const row = `<tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${typeClass}">${t.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 text-right">${formatCurrency(t.amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                            <span class="status-badge ${statusClass}">${t.status}</span>
                        </td>
                    </tr>`;
                    tableBody.innerHTML += row;
                });
            }

            function renderGroupActivity() {
                const contributionsGrid = document.getElementById('member-contributions-grid');
                contributionsGrid.innerHTML = '';
                [...users].sort((a,b) => b.totalContributions - a.totalContributions).forEach(u => {
                    contributionsGrid.innerHTML += `<div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <p class="font-semibold text-gray-800">${u.name}</p>
                        <p class="text-2xl font-bold text-blue-600">${formatCurrency(u.totalContributions)}</p>
                    </div>`;
                });

                const groupTableBody = document.getElementById('group-transactions-table');
                groupTableBody.innerHTML = '';
                const allTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
                 if(allTransactions.length === 0){
                    groupTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-6 text-gray-500">No group transactions yet.</td></tr>`;
                    return;
                }
                allTransactions.forEach(t => {
                    const user = users.find(u => u.id === t.userId);
                    const typeClass = t.type === 'CONTRIBUTION' ? 'text-green-600' : t.type === 'BORROW' ? 'text-red-600' : 'text-blue-600';
                    const statusClass = `status-${t.status.toLowerCase()}`;
                    const row = `<tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${typeClass}">${t.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 text-right">${formatCurrency(t.amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                            <span class="status-badge ${statusClass}">${t.status}</span>
                        </td>
                    </tr>`;
                    groupTableBody.innerHTML += row;
                });
            }

            function renderContributionChart() {
                const ctx = document.getElementById('contribution-chart')?.getContext('2d');
                if(!ctx) return;
                if (contributionChart) contributionChart.destroy();
                const totalContributions = users.reduce((acc, user) => acc + user.totalContributions, 0);
                const otherContributions = totalContributions > 0 ? totalContributions - currentUser.totalContributions : 1;
                contributionChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['My Contributions', 'Others'], datasets: [{ data: [currentUser.totalContributions, otherContributions], backgroundColor: ['#3b82f6', '#e5e7eb'], borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `${c.label}: ${formatCurrency(c.raw)}` } } } } });
            }
            
            async function callGeminiAPI(prompt, loaderElement, outputElement) {
                loaderElement.classList.remove('hidden');
                outputElement.classList.add('hidden');
                try {
                    const API_KEY = "";
                    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        outputElement.textContent = text;
                        outputElement.classList.remove('hidden');
                    } else { throw new Error("No content received from API."); }
                } catch (error) {
                    outputElement.textContent = `Error: ${error.message}`;
                    outputElement.classList.remove('hidden');
                } finally {
                    loaderElement.classList.add('hidden');
                }
            }

            function handleGetFinancialTip() {
                 const prompt = `I am part of a friend's emergency fund in India (currency is INR). My status: Contributions: ${formatCurrency(currentUser.totalContributions)}, Loan: ${formatCurrency(currentUser.amountBorrowed)}, Interest: ${formatCurrency(currentUser.interestAccrued)}. Total fund balance: ${formatCurrency(fund.totalBalance)}. Give one concise, actionable financial tip for an Indian context. If I have a loan, focus on repayment. If not, suggest wise fund usage. Keep it friendly.`;
                callGeminiAPI(prompt, document.getElementById('financial-tip-loader'), document.getElementById('financial-tip-output'));
            }
            function handleAnalyzeReason() {
                const reason = document.getElementById('loan-reason').value;
                if (!reason.trim()) { showModal('Input Required', 'Please enter a reason for the loan to analyze.'); return; }
                const prompt = `A member of a friends' emergency fund requests a loan for: "${reason}". Assess this with: 1. Urgency Level: (High, Medium, Low), 2. Category: (e.g., Medical, Vehicle), 3. Suggestion: A short, constructive alternative. Tone must be neutral, helpful.`;
                callGeminiAPI(prompt, document.getElementById('loan-reason-loader'), document.getElementById('loan-reason-output'));
            }
            function handleGetSummary() {
                 const userTransactions = transactions.filter(t => t.userId === currentUser.id).sort((a, b) => new Date(a.date) - new Date(b.date));
                 if (userTransactions.length === 0) { showModal('No Data', 'You have no transactions to summarize.'); return; }
                 const transactionList = userTransactions.map(t => `- ${t.date}: ${t.type} of ${formatCurrency(t.amount)} (${t.status})`).join('\n');
                 const prompt = `Generate a brief, narrative summary of these financial transactions (in INR) in a friendly tone. Mention the first contribution if available. Transactions:\n${transactionList}`;
                 callGeminiAPI(prompt, document.getElementById('summary-loader'), document.getElementById('summary-output'));
            }
            
             function showModal(title, message, buttons = [{ text: 'Close', class: 'bg-gray-200 hover:bg-gray-300 w-full sm:w-auto', action: () => modal.classList.add('hidden') }]) {
                modalTitle.textContent = title;
                modalMessage.innerHTML = message;
                modalButtons.innerHTML = '';
                buttons.forEach(btnInfo => {
                    const button = document.createElement('button');
                    button.textContent = btnInfo.text;
                    button.className = `px-6 py-2 rounded-md font-semibold ${btnInfo.class}`;
                    button.onclick = btnInfo.action;
                    modalButtons.appendChild(button);
                });
                modal.classList.remove('hidden');
            }
            
            // --- INITIALIZATION ---
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                userSelect.appendChild(option);
            });
            loginBtn.addEventListener('click', () => login(userSelect.value));
            logoutBtn.addEventListener('click', logout);
            menuBtn.addEventListener('click', toggleSidebar);
            closeMenuBtn.addEventListener('click', toggleSidebar);
            mobileOverlay.addEventListener('click', toggleSidebar);
        });
    </script>
</body>
</html>

